AzureDiagnostics
| where ResourceProvider == "MICROSOFT.KEYVAULT"
| where TimeGenerated > ago(24h)
| where isnotempty(identity_claim_objectid_g)
| summarize 
    TotalRequests = count(),
    ThrottledRequests = countif(httpStatusCode_d == 429),
    FailedRequests = countif(ResultType == "Error" or httpStatusCode_d >= 400),
    UniqueOperations = dcount(OperationName),
    VaultsAccessed = dcount(Resource),
    Operations = make_set(OperationName, 10)
    by CallerObjectId = tostring(identity_claim_objectid_g), CallerIPAddress
| extend ThrottleRate = round(100.0 * ThrottledRequests / TotalRequests, 2)
| top 20 by TotalRequests desc
| project CallerObjectId, CallerIPAddress, TotalRequests, ThrottledRequests, 
          ThrottleRate, FailedRequests, UniqueOperations, VaultsAccessed, Operations
