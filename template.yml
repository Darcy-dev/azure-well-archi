trigger: none
pr: none

parameters:
- name: operation
  displayName: 'Select Operation'
  type: string
  default: 'stop'
  values:
  - stop
  - start

- name: targetStamp
  displayName: 'Select Target Stamp (Manual Only)'
  type: string
  default: 'all'
  values:
  - all
  - D0
  - T02
  - S03
  - R01

# Schedule to stop clusters
schedules:
- cron: "0 5 * * 6"
  displayName: Stop Dev Clusters (6 PM UTC)
  branches:
    include:
    - feature-add-aks-shutdown-pipeline
  always: true

- cron: "0 2 * * 1"
  displayName: Start Dev Clusters
  branches:
    include:
    - feature-add-aks-shutdown-pipeline
  always: true

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: 'nonprod-infrastructure'

- name: azureSubscription
  value: 's00175-spn-nonprod-no-approval'
  
- name: slackWebhookUrl
  value: '$(SLACK_WEBHOOK_URL)'  
  
- name: clusters_azureSubscriptionD0
  value: |
    [
      {"name": "s00175akscloudappsd01-1", "resourceGroup": "s00175rgakscloudappsd01-1"},
      {"name": "s00175akscloudappsd02-3", "resourceGroup": "s00175rgakscloudappsd02-3"},
      {"name": "s00175akscloudappsd03-1", "resourceGroup": "s00175rgakscloudappsd03-1"},
      {"name": "s00175akscloudappsd03-2", "resourceGroup": "s00175rgakscloudappsd03-2"},
      {"name": "s00175akscloudappsd02-1", "resourceGroup": "s00175rgakscloudappsd02-1"}
    ]

- name: clusters_azureSubscriptionT02
  value: |
    [
      {"name": "s00175akscloudappst02-1", "resourceGroup": "s00175rgakscloudappst02-1"},
      {"name": "s00175akscloudappst02-3", "resourceGroup": "s00175rgakscloudappst02-3"}
    ]

- name: clusters_azureSubscriptionS03
  value: |
    [
      {"name": "s00175akscloudappss03-1", "resourceGroup": "s00175rgakscloudappss03-1"},
      {"name": "s00175akscloudappss03-3", "resourceGroup": "s00175rgakscloudappss03-3"}
    ]

- name: clusters_azureSubscriptionR01
  value: |
    [
      {"name": "s00175akscloudappsr01-1", "resourceGroup": "s00175rgakscloudappsr01-1"},
      {"name": "s00175akscloudappsr01-3", "resourceGroup": "s00175rgakscloudappsr01-3"}
    ]

stages:
- stage: StopClusters
  displayName: 'Stop All Non prd AKS'
  condition: |
    or(
      and(ne(variables['Build.Reason'], 'Schedule'), eq('${{ parameters.operation }}', 'stop')),
      and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], 'Stop Dev Clusters (6 PM UTC)'))
    )
  
  jobs:
  # --- D0 STOP JOB ---
  - job: 'StopAksClustersD0Stamp'
    displayName: 'Stop D0 stamp clusters'
    condition: or(eq(variables['Build.Reason'], 'Schedule'), or(eq('${{ parameters.targetStamp }}', 'all'), eq('${{ parameters.targetStamp }}', 'D0')))
    steps:
    - task: AzureCLI@2
      displayName: 'Stop AKS Clusters'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Starting cluster stop operations..."
          clusters='$(clusters_azureSubscriptionD0)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            echo "Processing cluster: $clusterName"
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv 2>/dev/null)
            if [ "$state" = "Stopped" ]; then
              echo "Cluster $clusterName is already stopped."
            else
              echo "Stopping cluster $clusterName..."
              az aks stop --name $clusterName --resource-group $resourceGroup
            fi
          done
    - task: AzureCLI@2
      displayName: 'Verify Cluster States'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          clusters='$(clusters_azureSubscriptionD0)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv)
            echo "Cluster: $clusterName | State: $state"
          done

  # --- T02 STOP JOB ---
  - job: StopAksClustersT02Stamp
    displayName: 'Stop T02 stamp clusters'
    condition: or(eq(variables['Build.Reason'], 'Schedule'), or(eq('${{ parameters.targetStamp }}', 'all'), eq('${{ parameters.targetStamp }}', 'T02')))
    steps:
    - task: AzureCLI@2
      displayName: 'Stop AKS Clusters T02 stamp'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Starting cluster stop operations for T02..."
          clusters='$(clusters_azureSubscriptionT02)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            echo "Processing cluster: $clusterName"
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv 2>/dev/null)
            if [ "$state" = "Stopped" ]; then
              echo "Cluster $clusterName is already stopped."
            else
              echo "Stopping cluster $clusterName..."
              az aks stop --name $clusterName --resource-group $resourceGroup
            fi
          done
    - task: AzureCLI@2
      displayName: 'Verify Cluster States'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          clusters='$(clusters_azureSubscriptionT02)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv)
            echo "Cluster: $clusterName | State: $state"
          done

  # --- S03 STOP JOB  ---
  - job: StopAksClustersS03Stamp
    displayName: 'Stop S03 stamp clusters'
    condition: or(eq(variables['Build.Reason'], 'Schedule'), or(eq('${{ parameters.targetStamp }}', 'all'), eq('${{ parameters.targetStamp }}', 'S03')))
    steps:
    - task: AzureCLI@2
      displayName: 'Stop AKS Clusters S03 stamp'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Starting cluster stop operations for S03..."
          clusters='$(clusters_azureSubscriptionS03)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            echo "Processing cluster: $clusterName"
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv 2>/dev/null)
            if [ "$state" = "Stopped" ]; then
              echo "Cluster $clusterName is already stopped."
            else
              echo "Stopping cluster $clusterName..."
              az aks stop --name $clusterName --resource-group $resourceGroup
            fi
          done
    - task: AzureCLI@2
      displayName: 'Verify Cluster States'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          clusters='$(clusters_azureSubscriptionS03)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv)
            echo "Cluster: $clusterName | State: $state"
          done

  # --- R01 STOP JOB  ---
  - job: StopAksClustersR01Stamp
    displayName: 'Stop R01 stamp clusters'
    condition: or(eq(variables['Build.Reason'], 'Schedule'), or(eq('${{ parameters.targetStamp }}', 'all'), eq('${{ parameters.targetStamp }}', 'R01')))
    steps:
    - task: AzureCLI@2
      displayName: 'Stop AKS Clusters R01 stamp'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Starting cluster stop operations for R01..."
          clusters='$(clusters_azureSubscriptionR01)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            echo "Processing cluster: $clusterName"
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv 2>/dev/null)
            if [ "$state" = "Stopped" ]; then
              echo "Cluster $clusterName is already stopped."
            else
              echo "Stopping cluster $clusterName..."
              az aks stop --name $clusterName --resource-group $resourceGroup
            fi
          done
    - task: AzureCLI@2
      displayName: 'Verify Cluster States'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          clusters='$(clusters_azureSubscriptionR01)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv)
            echo "Cluster: $clusterName | State: $state"
          done

# Slack Notification Stage for Stop Operations
- stage: NotifyStopCompletion
  displayName: 'Notify Stop Completion'
  dependsOn: StopClusters
  condition: succeeded('StopClusters')
  jobs:
  - job: SendSlackNotification
    displayName: 'Send Slack Notification for Stop'
    steps:
    - task: AzureCLI@2
      displayName: 'Collect Cluster Status and Send Slack Message'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Initialize message
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          text_content="*AKS Cluster Stop Operation Completed*\\n\\n"
          text_content+="_Pipeline:_ $(Build.DefinitionName)\\n"
          text_content+="_Build ID:_ $(Build.BuildId)\\n"
          text_content+="_Timestamp:_ $timestamp\\n"
          text_content+="_Target Stamp:_ ${{ parameters.targetStamp }}\\n\\n"
          
          # Function to check clusters
          check_clusters() {
            local stamp=$1
            local clusters_json=$2
            
            echo "$clusters_json" | jq -c '.[]' | while read cluster; do
              clusterName=$(echo $cluster | jq -r '.name')
              resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
              state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv 2>/dev/null || echo "ERROR")
              
              if [ "$state" = "Stopped" ]; then
                emoji="‚úÖ"
              elif [ "$state" = "Running" ]; then
                emoji="‚ö†Ô∏è"
              else
                emoji="‚ùå"
              fi
              
              echo "$emoji *$clusterName* - Status: \\\`$state\\\`\\n"
            done
          }
          
          # Check each stamp based on target
          if [[ "${{ parameters.targetStamp }}" == "all" ]] || [[ "${{ parameters.targetStamp }}" == "D0" ]]; then
            text_content+="*D0 Stamp Clusters:*\\n"
            d0_status=$(check_clusters "D0" '$(clusters_azureSubscriptionD0)')
            text_content+="$d0_status\\n"
          fi
          
          if [[ "${{ parameters.targetStamp }}" == "all" ]] || [[ "${{ parameters.targetStamp }}" == "T02" ]]; then
            text_content+="*T02 Stamp Clusters:*\\n"
            t02_status=$(check_clusters "T02" '$(clusters_azureSubscriptionT02)')
            text_content+="$t02_status\\n"
          fi
          
          if [[ "${{ parameters.targetStamp }}" == "all" ]] || [[ "${{ parameters.targetStamp }}" == "S03" ]]; then
            text_content+="*S03 Stamp Clusters:*\\n"
            s03_status=$(check_clusters "S03" '$(clusters_azureSubscriptionS03)')
            text_content+="$s03_status\\n"
          fi
          
          if [[ "${{ parameters.targetStamp }}" == "all" ]] || [[ "${{ parameters.targetStamp }}" == "R01" ]]; then
            text_content+="*R01 Stamp Clusters:*\\n"
            r01_status=$(check_clusters "R01" '$(clusters_azureSubscriptionR01)')
            text_content+="$r01_status\\n"
          fi
          
          text_content+="\\nView build: $(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
          
          # Create simplified Slack payload
          payload=$(jq -n \
            --arg text "$text_content" \
            --arg pretext "üõë AKS Cluster Stop Operation" \
            '{text: $text, pretext: $pretext}')
          
          # Send to Slack
          curl -X POST -H 'Content-type: application/json' \
            --data "$payload" \
            $(slackWebhookUrl)
          
          echo "Slack notification sent successfully"

- stage: StartClusters
  displayName: 'Start AKS Development Clusters'
  condition: |
    or(
      and(ne(variables['Build.Reason'], 'Schedule'), eq('${{ parameters.operation }}', 'start')),
      and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], 'Start Dev Clusters'))
    )

  jobs:
  
  # --- D0 START JOB ---
  - job: StartAKSClustersD0Stamp
    displayName: 'Start Multiple AKS Clusters D0 STAMP'
    condition: or(eq(variables['Build.Reason'], 'Schedule'), or(eq('${{ parameters.targetStamp }}', 'all'), eq('${{ parameters.targetStamp }}', 'D0')))
    steps:
    - task: AzureCLI@2
      displayName: 'Start AKS Clusters'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Starting cluster start operations..."
          clusters='$(clusters_azureSubscriptionD0)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            echo "Processing cluster: $clusterName"
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv 2>/dev/null)
            if [ "$state" = "Running" ]; then
              echo "Cluster $clusterName is already running."
            else
              echo "Starting cluster $clusterName..."
              az aks start --name $clusterName --resource-group $resourceGroup
            fi
          done
    - task: AzureCLI@2
      displayName: 'Verify Cluster States'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          clusters='$(clusters_azureSubscriptionD0)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv)
            echo "Cluster: $clusterName | State: $state"
          done

  # --- T02 START JOB ---
  - job: StartAKSClustersT02Stamp
    displayName: 'Start Multiple AKS Clusters T02 STAMP'
    condition: or(eq(variables['Build.Reason'], 'Schedule'), or(eq('${{ parameters.targetStamp }}', 'all'), eq('${{ parameters.targetStamp }}', 'T02')))
    steps:
    - task: AzureCLI@2
      displayName: 'Start AKS Clusters'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Starting cluster start operations..."
          clusters='$(clusters_azureSubscriptionT02)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            echo "Processing cluster: $clusterName"
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv 2>/dev/null)
            if [ "$state" = "Running" ]; then
              echo "Cluster $clusterName is already running."
            else
              echo "Starting cluster $clusterName..."
              az aks start --name $clusterName --resource-group $resourceGroup
            fi
          done
    - task: AzureCLI@2
      displayName: 'Verify Cluster States'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          clusters='$(clusters_azureSubscriptionT02)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv)
            echo "Cluster: $clusterName | State: $state"
          done

  # --- S03 START JOB ---
  - job: StartAKSClustersS03Stamp
    displayName: 'Start Multiple AKS Clusters S03 STAMP'
    condition: or(eq(variables['Build.Reason'], 'Schedule'), or(eq('${{ parameters.targetStamp }}', 'all'), eq('${{ parameters.targetStamp }}', 'S03')))
    steps:
    - task: AzureCLI@2
      displayName: 'Start AKS Clusters'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Starting cluster start operations for S03..."
          clusters='$(clusters_azureSubscriptionS03)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            echo "Processing cluster: $clusterName"
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv 2>/dev/null)
            if [ "$state" = "Running" ]; then
              echo "Cluster $clusterName is already running."
            else
              echo "Starting cluster $clusterName..."
              az aks start --name $clusterName --resource-group $resourceGroup
            fi
          done
    - task: AzureCLI@2
      displayName: 'Verify Cluster States'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          clusters='$(clusters_azureSubscriptionS03)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv)
            echo "Cluster: $clusterName | State: $state"
          done

  # --- R01 START JOB ---
  - job: StartAKSClustersR01Stamp
    displayName: 'Start Multiple AKS Clusters R01 STAMP'
    condition: or(eq(variables['Build.Reason'], 'Schedule'), or(eq('${{ parameters.targetStamp }}', 'all'), eq('${{ parameters.targetStamp }}', 'R01')))
    steps:
    - task: AzureCLI@2
      displayName: 'Start AKS Clusters'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Starting cluster start operations for R01..."
          clusters='$(clusters_azureSubscriptionR01)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            echo "Processing cluster: $clusterName"
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv 2>/dev/null)
            if [ "$state" = "Running" ]; then
              echo "Cluster $clusterName is already running."
            else
              echo "Starting cluster $clusterName..."
              az aks start --name $clusterName --resource-group $resourceGroup
            fi
          done
    - task: AzureCLI@2
      displayName: 'Verify Cluster States'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          clusters='$(clusters_azureSubscriptionR01)'
          echo "$clusters" | jq -c '.[]' | while read cluster; do
            clusterName=$(echo $cluster | jq -r '.name')
            resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
            state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv)
            echo "Cluster: $clusterName | State: $state"
          done

# Slack Notification Stage for Start Operations
- stage: NotifyStartCompletion
  displayName: 'Notify Start Completion'
  dependsOn: StartClusters
  condition: succeeded('StartClusters')
  jobs:
  - job: SendSlackNotification
    displayName: 'Send Slack Notification for Start'
    steps:
    - task: AzureCLI@2
      displayName: 'Collect Cluster Status and Send Slack Message'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Initialize message
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          text_content="*AKS Cluster Start Operation Completed* üöÄ\\n\\n"
          text_content+="_Pipeline:_ $(Build.DefinitionName)\\n"
          text_content+="_Build ID:_ $(Build.BuildId)\\n"
          text_content+="_Timestamp:_ $timestamp\\n"
          text_content+="_Target Stamp:_ ${{ parameters.targetStamp }}\\n\\n"
          
          # Function to check clusters
          check_clusters() {
            local stamp=$1
            local clusters_json=$2
            
            echo "$clusters_json" | jq -c '.[]' | while read cluster; do
              clusterName=$(echo $cluster | jq -r '.name')
              resourceGroup=$(echo $cluster | jq -r '.resourceGroup')
              state=$(az aks show --name $clusterName --resource-group $resourceGroup --query 'powerState.code' --output tsv 2>/dev/null || echo "ERROR")
              
              if [ "$state" = "Running" ]; then
                emoji="‚úÖ"
              elif [ "$state" = "Stopped" ]; then
                emoji="‚ö†Ô∏è"
              else
                emoji="‚ùå"
              fi
              
              echo "$emoji *$clusterName* - Status: \\\`$state\\\`\\n"
            done
          }
          
          # Check each stamp based on target
          if [[ "${{ parameters.targetStamp }}" == "all" ]] || [[ "${{ parameters.targetStamp }}" == "D0" ]]; then
            text_content+="*D0 Stamp Clusters:*\\n"
            d0_status=$(check_clusters "D0" '$(clusters_azureSubscriptionD0)')
            text_content+="$d0_status\\n"
          fi
          
          if [[ "${{ parameters.targetStamp }}" == "all" ]] || [[ "${{ parameters.targetStamp }}" == "T02" ]]; then
            text_content+="*T02 Stamp Clusters:*\\n"
            t02_status=$(check_clusters "T02" '$(clusters_azureSubscriptionT02)')
            text_content+="$t02_status\\n"
          fi
          
          if [[ "${{ parameters.targetStamp }}" == "all" ]] || [[ "${{ parameters.targetStamp }}" == "S03" ]]; then
            text_content+="*S03 Stamp Clusters:*\\n"
            s03_status=$(check_clusters "S03" '$(clusters_azureSubscriptionS03)')
            text_content+="$s03_status\\n"
          fi
          
          if [[ "${{ parameters.targetStamp }}" == "all" ]] || [[ "${{ parameters.targetStamp }}" == "R01" ]]; then
            text_content+="*R01 Stamp Clusters:*\\n"
            r01_status=$(check_clusters "R01" '$(clusters_azureSubscriptionR01)')
            text_content+="$r01_status\\n"
          fi
          
          text_content+="\\nView build: $(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
          
          # Create simplified Slack payload
          payload=$(jq -n \
            --arg text "$text_content" \
            --arg pretext "üöÄ AKS Cluster Start Operation" \
            '{text: $text, pretext: $pretext}')
          
          # Send to Slack
          curl -X POST -H 'Content-type: application/json' \
            --data "$payload" \
            $(slackWebhookUrl)
          
          echo "Slack notification sent successfully"
